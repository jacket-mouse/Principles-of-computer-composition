# 0x01 读写操作（不考）

**以直接映像方式为例，说明在带有Cache的存储系统中，“读”操作是怎样完成的。**

**参考答案要点：**
    当CPU发出主存地址后，Cache地址映射机构按照直接映射方式将主存地址标记与Cache特定字块的标记进行比较，以判断出所访主存字（主存地址的内容）是否已在Cache中。若命中，直接访问Cache，将该字送至CPU；若未命中，一方面要访问主存，将该字传送给CPU，与此同时，要按照直接映射方式转换的Cache地址将该字所在的主存块装入Cache，如果此时Cache已装满，就要执行替换算法，腾出空位才能将新的主存块调入。

**以全相联映射技术为例，说明在带有Cache的存储系统中，“读”操作是怎样完成的。**

**参考答案要点：** 
    当CPU发出主存地址后，地址映射机构按照全相联映射方式将主存地址标记与Cache所有字块的标记进行比较，以判断出所访主存字（主存地址的内容）是否已在Cache中。若命中，直接访问Cache，将该字送至CPU；若未命中，一方面要访问主存，将该字传送给 CPU，与此同时，要按照全相联映射方式转换的Cache地址将该字所在的主存块装入Cache，如果此时Cache已装满，就要执行替换算法，腾出空位才能将新的主存块调入。

# 0x02 地址映射

## Cache
![[Pasted image 20240103100610.png]]
Cache line：字块，又叫Cache行
Cache line的内容与Cache地址是不一样的，现在默认Cache line的内容是分为：**标记阵列容量**（替换算法控制位、脏位、标记（tag）项、有效位）+ **每行存储的数据**。而Cache地址是：**块号 + 块内地址。**

### Cache地址

主存字块标记（Tag）记录的是阵列容量的标记信息。通俗的说，就是记录一些和替换算法有关，以及保持Cache和主存数据一致性的一些信息，不属于Cache地址。

Cache地址包括Cache字块地址、块内字（节）地址
Cache字块地址分为Cache组地址和组内块号
**Cache组地址即为主存地址的组地址。因此，主存地址是不包括组内块号的（符合全相联映射：没有映射到Cache之前只知道会到哪个组（此处又符合直接映射），而不知道具体块号，只有真正映射到Cache后才知道在组内的哪一块）所以，组相联映射是既有直接映射，又有全相联映射。**


### 主存地址

***假设计算机主存大小256MB，按字节编址，数据cache有8行，数据块大小64B。主存数据在cache里应该怎么存放？二者应该建立怎样的对应关系？***
#### 直接映射
主存地址由三部分组成：**主存字块标记+Cache字块地址+块内字（节）地址**

|主存块号|块内地址|
|---|---|
|主存字块标记（19位） + cache行号（Cache字块地址）（3位） = 22位 |6位|
假如访问地址为：0…01000 **001110**
**查找策略：**
1. 根据主存块号后3位确定cache行号
2. 如果主存块号前19位与cache标记匹配且有效位为1，则cache命中，访问块内地址为001110的单元
3. 若cache不命中或有效位为0，则正常访问内存
#### 全相联映射

主存地址由两部分组成：**主存字块标记+块内字（节）地址**

|主存块号|块内地址|
|---|---|
|（主存字块标记）22位 |6位|

#### 组相联映射

主存由三部分组成：**主存字块标记+组地址+块内字（节）地址**

|主存块号|块内地址|
|---|---|
|主存字块标记（20位） + cache组号（2位） = 22位|6位|

## 注意

- **块内字节地址**按教材写为**字块内地址**亦可，所以**字块内地址**既可以表示**块内字地址**，又可以表示**块内字节地址**。
- 根据题目要求，看存储器按字节编地址，还是按字编址，没说就是都可以。但按字节编址必须告诉一个字是多少位以及一个字块是多少字才可以算出来，否则就是默认按字编址。
- 看清题目问的是主存地址还是Cache地址，Cache地址是没有主存字块标记的。

# 0x03 Cache容量

**Cache容量** = 行数 * （$2^{块内地址位}$ * 8 bit）
**Cache总容量** = 行数 * （标记项 + $2^{块内地址位}$ * 8 bit）

# 0x04 题目整理

### 命中率 and 效率

**设某机主存容量为4MB，Cache容量为16KB，每字块有8个字，每字32位，设计一个四路组相联映射（即Cache每组内共有4个字块）的Cache组织。**

**（1）画出主存地址字段中各段的位数；**
- 按字编址：
	解法一：
	Cache容量：16KB = $2^{12}$个字 = $2^9$个字块
	组数 = $2^7$组，所以组地址为7位。
	解法二：
	1. 求出直接映射：
	主存容量：4MB = $2^{20}$个字 = $2^{17}$个字块
	主存容量 / Cache容量 = $2^8$
	**所以主存字块标记位数为8位**（期末考试错了，以为是Cache字块标记位8位，和解法一得到的结果不一样，血的教训）
	
| 主存字块标记 | Cache字块地址 | 块内字地址 |
|:------------:| ------------- | ---------- |
|     8位      | 9位           | 3位        |
	2. 然后根据路数Cache减去相应的位数	，主存字块标记加上相同的位数。

![[Pasted image 20240102193415.png]]

- 按字节编址：
![[Pasted image 20240102193449.png]]


**（2）设Cache的初态为空，CPU依次从主存第0、1、2--89号单元读出90个字（主存一次读出一个字），并重复按此次序读8次，问命中率是多少？**
读出过程：
	- 读第0个字时，Cache里没有，将这一个字块全部加进Cache，所以读第1、2、3、、、7个字都是直接从Cache里读取。
	- 但当读第8个字时，Cache里又没有了，所以重复上述过程，直至90个字。我们可以算出共有12次是从主存读取的，剩下的78次都是直接从Cache中读取。
	- 之后又重复读8次，但从第2次开始，Cache里已经有我们要读的全部的90个字了，所以后面的630次读取，全部是从Cache里读取的。
	- 最后，算出从Cache里读了708次，从主存读了12次，总共720次，算出来命中率为：708 / 720 = 0.983

**（3）若Cache的速度是主存的6倍，试问有Cache和无Cache相比，速度约提高多少倍？**

设Cache的存取周期为t，则根据题意，主存的存取周期为6t。
则有无Cache系统的速度之比为：
![[Pasted image 20240102194322.png]]
所以，速度提高了5.54 **-1**=4.54倍。（记得-1）

### 组相联映射

**某Cache共32个字块，每个字块有32个字，每个字为32位，采用4路组相联映射；存储器按字节编址，内存地址为16位。请问（必须写出分析步骤）：**

**1）Cache地址各字段如何划分（各需多少位）？**
Cache地址共12位。其中块内字节地址7位、Cache字块地址5位。
![[Pasted image 20240102192924.png]]


**2）写出内存地址375FH可能映射成的Cache地址（用16进制表示）。**

题目中写出内存地址为16位，就是按字节编址后的16位地址，刚开始看时，看糊涂了，没反应过来。
375FH= 0011 01*11 0***101 1111**
**在两者中间插入Cache的组内块号，并去掉主存字块标记后，就形成了Cache地址。（组内块号是全相联映射形成的，具有随机性）**
可能的Cache地址有4个（组内块号是不确定的），分别是：
- 110 00 101 1111（十六进制：0C5FH ）
- 110 01 101 1111（十六进制：0CDFH ）
- 110 10 101 1111（十六进制：0D5FH ）
- 110 11 101 1111（十六进制：0DDFH ）

**3）如果是八路组相联映射，计算主存87号（十进制）单元所在主存块应装入到的Cache组号。**

八路组相联时Cache字块的组数 = 32 / 8 = 4（组）
每个字块的字节数=32×32/8=128 bytes（**首先要将单位统一**）
存储器按字节编址，故主存87号单元对应的块号= INT（87/128）=0，
所以，对应的Cache组号 i = j mod Q = 0 mod 4 = 0，映射到第0组。


## 主存地址 and Cache地址
**设主存容量为1MB，采用直接映射方式的Cache容量为16KB，块长为4，每字32位。试问主存地址为ABCDEH的存储单元在Cache中的什么位置？**

**答案要点：**
主存地址ABCDEH，Cache的地址为14位，其中字块内地址为4位，Cache字块地址为10位。采用直接映射方式，只要将**主存地址后14位地址与Cache的14位地址相同**就行了。因此：
ABCDEH=1010 1011 1100 1101 1110B（字节编址），其中，后14位地址为11 1100 1101 1110，用十六进制描述为3CDEH，这就是指定的主存单元在Cache中的位置。

## Cache地址
有效容量为128KB的Cache，每块16字节，8路组相联，**字节地址**为1234567H的单元调入该Cache中，其中主存字块标记应是
Cache $2^{17}$B  = $2^{13}$字块
主存地址：
	- 主存字块标记：根据字节地址推出应是前14位
	- 组地址：10位
	- 块内字节地址：4位
Cache地址（17位）：
	- Cache字块地址：13位（Cache组地址（10位） + 组内块号（3位））求出总位数后，先求组内块号更好求
	- 块内字节地址：4位

